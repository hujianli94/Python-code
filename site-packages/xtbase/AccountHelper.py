#coding=utf8
__author__ = '9020win764z'

import MysqlHelper
import types
from net.RPCClient import request
from pyenv import *

class AccountHelper:
    def __init__(self):
        self.mysql = MysqlHelper.XtMysql()

    def getAccount(self, accountId):
        ret = None
        sql = ""
        if accountId.find("_") != -1:
            # subAccount
            sql = """
            select main.types as m_nBrokerType, main.platform_id as m_nPlatformID, \
            main.broker_id as m_strBrokerID, main.stk_type as m_nAccountType, main.name as m_strAccountID,\
            sub.name as m_strSubAccount from account_account as main, account_subaccount as sub \
            where sub.name = '%s' and sub.parent_account_id = main.id;\
            """ % accountId
        else:
            # mainAccount
            sql = """
            select main.types as m_nBrokerType, main.platform_id as m_nPlatformID, main.broker_id as m_strBrokerID, \
            main.stk_type as m_nAccountType, main.name as m_strAccountID from account_account as main \
            where main.name = '%s';\
            """ % accountId

        data = self.mysql.execQuery(sql)
        if len(data) == 1:
            ret = data[0]
        return ret

    def getAccountKey(self, accountId):
        accountInfo = self.getAccount(accountId)
        return self._getAccountKey(accountInfo)

    def _getAccountKey(self, accountInfo):
        tags = ['m_nBrokerType', 'm_nPlatformID', 'm_strBrokerID', 'm_nAccountType', 'm_strAccountID', 'm_strSubAccount']
        datas = [str(accountInfo.get(x, "")) for x in tags]
        return "____".join(datas)


def getAccount(accountId):
    heler = AccountHelper()
    return heler.getAccount(accountId)

def getAccountKey(accountId):
    heler = AccountHelper()
    return heler._getAccountKey(accountId)


def query(account, metaId):
    address = getAddress("xtservice")
    data = request(address, "webservice", {"function":"queryData", "param":{"account":account, "typeId":metaId}})
    return data["content"]

if __name__ == "__main__":
    print getAccount("20305788_00")
    print getAccount("20305788")

    print getAccountKey("20305788_00")
    print getAccountKey("20305788")
